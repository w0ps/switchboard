<template name="chat">
  {{#with getConversation this}}
    <section class="chat">
      <div>
        {{#each speakingTurns}}
          <div class="speakingturn{{whose}}">
            {{#if isOwner}}
              <span class="name">me</span>
            {{else}}
              <span class="name">{{userIdToUserName createdBy}}</span>
              {{> avatar}}
            {{/if}}
          </div>
          {{#each streaks}}
            <div class="streak{{whose}}">
              {{#each lines}}
                <span class="chatline{{whose}}">
                  {{text}}
                </span>
              {{/each}}
            </div>
            <p class="chat-timecode{{whose}}">{{formatTime created}}</p>
          {{/each}}
        {{/each}}
        {{#each need.writingMessage}}
          {{#if compare this currentUser._id '!=='}}
            <div class="streak">
              <chatline>{{userIdToUserName this}} is typing...</chatline>
            </div>
          {{/if}}
        {{/each}}
      </div>
    </section>
    <footer id="need-detail-footer">
      {{#with need}}
        {{#if isAllowed 'post chatmessages'}}
          <textarea style="width: calc( 100% - 25px * {{inChat.length}} )" class="inverted" name="message" placeholder="..." autocomplete="off" resize="none"></textarea>
        {{/if}}
        {{#each inChat}}
          {{{getAvatar this}}}
        {{/each}}
        {{#each responses}}
          {{> response}}
        {{/each}}
      {{/with}}
    </footer>
  {{/with}}
</template>
